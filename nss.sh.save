#!/bin/bash
###################################################################
#  Prime_TGIF_Network Support        	 			  #
#  This Script will test the /usr/local/etc/DMR_Hosts.txt File    #
#  and /root/DMR_Hosts File for the prime.tgif.network IPAddress  #
#  and add the required line to /root/DMR_Hosts.txt if it was 	  #
#  not found in ether file				 	  #
#								  #
#  VE3RD                               2020=04-22                 #
###################################################################
sudo mount -o remount,rw /
export NCURSES_NO_UTF8_ACS=1
declare -i mode=0
declare -r TAB="`echo -e "\t"`"
linetext=""
fname=""
## mode=0 - Addm New Line to Custom
## mode=1 - Accept Main File
## mode=2 - Accept Custom File


mode=""

#use_colors = ON
#screen_color = (WHITE,BLUE,ON)
#title_color = (YELLOW,RED,ON)
sed -i '/use_colors = /c\use_colors = ON' ~/.dialogrc
sed -i '/screen_color = /c\screen_color = (WHITE,BLUE,ON)' ~/.dialogrc
sed -i '/title_color = /c\title_color = (YELLOW,RED,ON)' ~/.dialogrc

echo -e '\e[1;44m'

#m1=$(sudo sed -n "/\t$m2/p" /usr/local/etc/DMR_Hosts.txt)
function parseline
{
clear
 p1=$(echo "$linetext" | cut -d$'\t' -f1)
 p2=$(echo "$linetext" | cut -d$'\t' -f3)
 p3=$(echo "$linetext" | cut -d$'\t' -f4)
 p4=$(echo "$linetext" | cut -d$'\t' -f6)
 p5=$(echo "$linetext" | cut -d$'\t' -f7)
echo "$p1${TAB}$p2${TAB}$p3${TAB}$p4${TAB}$p5"
}

function addline
{
p1=""
p2=""
p3=""
p4=""
p5=""
displayline
}
function readmain
{
echo "ReadMain"
fname="/usr/local/etc/DMR_Hosts.txt"
mode=1
linetext=$(tail /usr/local/etc/DMR_Hosts.txt | sed -n '/'"$SVR"'/p')
	if [ -z "$linetext" ]; then
		echo "Nothing Found for $SVR"
		readcustom
	else
		echo "$linetext"
		parseline
		displayline
	fi

}
function readcustom
{
fname="/root/DMR_Hosts.txt"
mode=2
linetext=$(tail /root/DMR_Hosts.txt | sed -n '/'"$SVR"'/p')
	if [ -z "$linetext" ]; then
		echo "Nothing Found for $SVR"
		addline
	else
		echo "$linetext"
		parseline
		displayline
	fi



linetext=$(tail /root/DMR_Hosts.txt | sed -n '/"$SVR"/p')
	if [ "$linetext" ]; then
		parseline
	fi

}

function displayline
{
name="$p1"
did="$p2"
addr="$p3"
port="$p4"
passwd="$p5"

# open fd
exec 3>&1

# Store data to $VALUES variable
VALUES=$(dialog --ok-label "Submit" \
	  --backtitle "TGIF Network Special Access Script - VE3RD" \
	  --title "Server Access Data Fields in $fname" \
	  --form "Edit Data Fields or Accept Found Data" \
18 50 0 \
	"     Server Name:" 1 1	"$name" 	1 18 25 0 \
	"  	Server ID:" 2 1	"$sid"  	2 18 25 0 \
	"  Server Address:" 2 1	"$addr"  	2 18 25 0 \
	"            Port:" 3 1	"$port"  	3 18 25 0 \
	"        Password:" 4 1	"$passwd" 	4 18 25 0 \
2>&1 1>&3)

# close fd
exec 3>&-
}

if [ "$mode"="0"
#######################################################################
# show an inputbox
SVR=$(dialog --title "Test for Existence of Server Hostname" \
--backtitle "New TGIF Server Access Script - VE3RD" \
--inputbox "Enter the Server Address " 8 60 3>&1 1>&2 2>&3 3>&- )

# get response
response=$?
#echo "Response=$response"
# get data stored in $OUPUT using input redirection
#SVR=$(<$OUTPUT)

readmain

readcustom

exit
# display values just entered
m1=$(echo "$VALUES" | sed -n 1p)
m2=$(echo "$VALUES" | sed -n 2p)
m3=$(echo "$VALUES" | sed -n 3p)
m4=$(echo "$VALUES" | sed -n 4p)

echo "    Server Name : $m1"
echo " Server Address : $m2"
echo "    Server Port : $m3"
echo "  Server Passwd : $m4"



#echo -e "A${TAB}B"

textstr="$m1${TAB}${TAB}0000${TAB}$m2${TAB}${TAB}$m4${TAB}$m3"
echo "$textstr"
readline
exit




m1=$(sudo sed -n "/\t$m2/p" /usr/local/etc/DMR_Hosts.txt)

if [ -z "$m1" ]; then
	echo " The Data Entry is  missing from /usr/local/etc/DMR_Hosts.txt"
	echo " Checking Root DMR_Hosts.txt"
else
	echo " /usr/local/etc/DMR_Hosts.txt is Fine"
	echo " No Action Taken"
	exit
fi

m2=$(sudo sed -n "/\t$m2/p" /root/DMR_Hosts.txt)

if [ -z "$m2" ]; then
		echo "/root/DMR_Hosts.txt Updated "
		echo "Now doing a pstar-update and reboot"

		sudo sed -i "\$a$textstr" /root/DMR_Hosts.txt
		sudo pistar-update
		sudo reboot

else
		echo " /root/DMR_Host.txt is fine"
		echo "Doing a pistar-update to load the file"
		echo "Deleting Server Line & Re-Writing it"
 		sudo sed '$d' /root/DMR_Hosts.txt 
		sudo sed -i "\$a$textstr" /root/DMR_Hosts.txt
 
		sudo pistar-update
		sudo reboot

fi
